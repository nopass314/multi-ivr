# Інтерактивне голосове меню
PHP бібліотека для налаштування голосового меню Zadarma

*Прочитайте опис на інших мовах:*
* [Англійська](README.md)
* [Іспанська](README_ES.md)
* [Німецька](README_DE.md)
* [Польська](README_PL.md)
* [Російська](README_RU.md)
* [Французька](README_FR.md)

## Вимоги:
* PHP >= 7.2.0
* cURL
* TLS v1.2
* php-mbstring
## Встановлення
Додайте залежність `zadarma/multi-ivr` до файлу composer.json вашого проекта:
```
composer require zadarma/multi-ivr
```

## Можливості

Реалізовано можливість гнучкого конфігурування голосового меню за допомогою фільтрів і правил.
Підтримується чотири види фільтрів:
* за номером абонента, що телефонує;
* за номером, на який дзвонять;
* фільтр за роскладом;
* дія користувача.

Правило складається з фільтрів і дії. Дія виконується в разі збігу умов фільтрів правила.
Дії бувають двох типів - перехід до меню (відтворюється звуковий файл і очікується дія від користувача) і переведення виклику на номер телефону або сценарій (дзвінки відразу на декілька номерів або blacklist).

Розглянемо можливості більш детально нижче за текстом.
## Використання

Для прийому повідомлень про дзвінки необхідно створити відкрите для загального доступу посилання, яке буде приймати POST-запити з інформацією з системи Zadarma.
Це посилання необхідно вказати у [особистому кабінеті](https://my.zadarma.com/api/) під заголовком "Повідомлення про дзвінки в АТС".

За посиланням необхідно розмістити наступний php код:
```php
<?php

use MultiIvr\MultiIvr;

if (isset($_GET['zd_echo'])) {
    exit($_GET['zd_echo']);
}

require_once 'vendor/autoload.php';
$key = 'Your api key';
$secret = 'Your api secret';
$ivrMenuConfig = 'your config';
MultiIvr::default()->handle($key, $secret, $ivrMenuConfig);
```

`$key` та `$secret` - ключі для авторизації в інтерфейсі API, їх необхідно отримати в [особистому кабінеті](https://my.zadarma.com/api/).
`$ivrMenuConfig` - текстовий конфіг голосового меню, про нього докладніше розкажемо нижче.

## Приклад конфігу

Завдання:

За допомогою голосового меню розділити клієнтів на 3 групи:

1. При натисканні на кнопку 1 направляти дзвінки в відділ продажів.
2. При натисканні на кнопку 2 направляти дзвінки в відділ закупок.
3. При натисканні на кнопку 3 направляти дзвінки в відділ обслуговування.
4. Якщо залишилися на лінії, то дзвінок направляється на секретаря.

Наведемо правила голосового меню:
```
start default action=goto action-target=main

menu name=main playfile=file1
menu name=main button=1 action=redirect action-target=100
menu name=main button=2 action=redirect action-target=101
menu name=main button=3 action=redirect action-target=102
menu name=main default action=redirect action-target=103
```

## Синтаксис конфігу голосового меню

Конфіг має 3 допустимих тега - start, menu, schedule. Кожний тег має власні дозволені атрибути, вони описані нижче.
Назва та значення атрибута розділяється знаком рівності `attribute=attributeValue`.

Атрибути розділяються пробілами, тому неприпустимо використовувати пробіли в значеннях атрибутів.

### Тег start 

Обов’язковий. Задає правила початку вхідного дзвінка в АТС.

Він має наступні атрибути:

1. action - тип дії. 

    Можливі 2 значення: 
    * redirect - перевод на сценарій або внутрішній номер телефону АТС;
    * goto - перехід на голосове меню за його назвою.

1. action-target - мета дії. 

    Якщо атрибут action має значення:
    * redirect
    
       Необхідно вказати внутрішній номер телефону, або id сценарія.
    
       Сценарії створюються в [особистому кабінеті](https://my.zadarma.com/mypbx/in_calls/). 
       Id сценарію задається у форматі 0-1, де 0 - номер голосового меню, 1 - номер сценарію.
    
       Сценарій також може мати значення blacklist - в цьому випадку дзвінок буде відхилений з сигналом зайнято.
    
    * goto
    
       Необхідно вказати назву голосового меню.
        
1. callerid - фільтр за номерами, абонентім, що телефонують, 
вказуються через кому. 
1. calleddid - фільтр за номерами, на які телефонують, вказуються через кому. 
1. default - признак дії за замовчуванням. Одна з дій повинна будь-що мати признак default.
1. schedule - фільтр з назвою розкладу, за ним можно вказати робочий або обідній час.

**Приклад start з декількома фільтрами:**

```
start default action=redirect action-target=100
start callerid=111 calleddid=112 action=redirect action-target=blacklist 
start callerid=111 action=redirect action-target=101
start calleddid=112 action=redirect action-target=102 
```

* перше правило - якщо подзвонив номер 111 на номер 112, то виконується перевод дзвінка на сценарій blacklist (покласти трубку з сигналом зайнято)
* якщо перше правило не було виконано, то перевіряється наступне по порядку;
* якщо жодне правило не було виконано, то виконується дія за замовчування - перевод дзвінка на номер 100.


### Тег menu
Задає елементи голосового меню, правила переходу між ними, правила переводу на сценарії або внутрішні номери телефонів АТС. 

Він має ті самі атрибути, як start, а також:

1. name - назва елемента голосового меню, обов’язковий атрибут.
1. playfile - id файла,що відтворюється, обов’язковий атрибут.

   Вказується один раз для голосового меню в окремому від фільтрів рядку, відповідає за файл голосового меню, що відтворюється. id завантаженого або начитаного файлу можна дізнатися в [особистому кабінеті](https://my.zadarma.com/mypbx/in_calls/).
1. timeout - час очікування вводу в секундах.

   Вказується в одному рядку з атрибутом playfile, значення за замовчуванням - 3.
1. attempts - кількість повторів файлу, що відтворюється якщо абонент нічого не натиснув.

   Вказується в одному рядку з атрибутом playfile, значення за замовчуванням - 1
1. maxsymbols - максимальна кількість символів, 
введення яких очікувати.
   
   Вказується в одному рядку з атрибутом playfile, значення за замовчуванням - 1.
1. button - фільтр натискання однієї або декількох кнопок.

### Тег schedule 

1. name - назва розкладу.
1. data - опис розкладу.

Приклад розкладу:
```
schedule name=work data=mo,tu,we,th,fr:0800-1300;1400-1700,sa:0900-1500
```
Розклад має назву work, вказано, що з понеділка по п’ятницю час з 08:00 до 12:59:59 та з 14:00 до 16:59:59, в суботу з 09:00 до 14:59:59.

Допустимі назви днів тижня: **su, mo, tu, we, th, fr, sa**.

Час можливо вказати для кожного дня тижня у вигляді одного або декількох інтервалів, між якими ставиться крапка з комою.
Інтервал складається з двох значень, розділених дефісом - часу початку і часу закінчення. Час початку і закінчення має складатися з чотирьох цифр.
Перші дві цифри відповідають за години, інші за хвилини.

Також можливо задати час одразу для декількох днів тижня, вказавши дні тижня через кому, а час через двокрапку, ось так `mo,tu,we,th,fr:0800-1300;1400-1700`.

Якщо час не вказано, то береться цілий день від 00:00:00 до 23:59:59. 
Наприклад, `mo,tu,we,th,fr:0800-1300;1400-1700,sa,su` mo,tu,we,th,fr мають інтервали часу з 08:00 до 12:59:59 та з 14:00 до 16:59:59, а sa,su від 00:00:00 до 23:59:59. 

Приклад розкладу:
```
schedule name=relax data=mo,tu,we,th,fr:1300-1400,sa,su
```
Розклад має назву relax, вказано, що з понеділка по п’ятницю години відпочинку з 13:00:00 до 13:59:59, в суботу та неділю вихідні.

### Правила

До правил відносяться строки конфігу, які мають у своїх атрибутах фільтри.

До фільтрів, як було описано вище, відносяться атрибути: callerid, calleddid, button, schedule.
Правила описують умови виконання певних дій в залежності від 
 номеру, що телефонує, номеру, на який дзвонять, дії користувача і поточного часу.

**Пріоритет правил визначається за порядком слідування рядків.**

**Приклад правил:**

```
...
menu name=main button=1 callerid=111 calleddid=112 schedule=dinner action=redirect action-target=101
menu name=main button=1 callerid=111 action=redirect action-target=102
menu name=main button=1 action=redirect action-target=103
menu name=main default action=redirect action-target=104
...

schedule name=dinner data=mo,tu,we,th,fr:1300-1400
```
* перше правило - якщо подзвонив номер 111 на номер 112, натиснув кнопку 1 в обідній час, то виконується перевод дзвінка на номер 101;
* якщо перше правило не було виконано, то перевіряється наступне по порядку;
* якщо жодне з правил не було виконано, то виконується дія за замовчуванням - перевод дзвінка на номер 104.

## Приклад багаторівневого голосового меню:
```
start callerid=111,222 action=redirect action-target=blacklist
start schedule=off-the-clock action=goto action-target=off-the-clock
start schedule=dinner action=goto action-target=dinner
start callerid=112,223 action=goto action-target=main.1
start default action=goto action-target=main

menu name=main playfile=43d8a740ec032766 timeout=5 attempts=2 maxsymbols=2
menu name=main button=1 action=goto action-target=main.1
menu name=main button=2 action=goto action-target=main.2
menu name=main button=3 action=redirect action-target=0-1
menu name=main button=4 action=redirect action-target=101
menu name=main button=10 action=redirect action-target=110
menu name=main default action=redirect action-target=100

menu name=main.1 playfile=a279dd3a1da19e57
menu name=main.1 button=1 action=redirect action-target=0-2
menu name=main.1 button=2 action=redirect action-target=102
menu name=main.1 button=* action=goto action-target=main
menu name=main.1 default action=goto action-target=main.1

menu name=main.2 playfile=a6842305f1996e34
menu name=main.2 button=1 action=redirect action-target=0-3
menu name=main.2 button=2 action=redirect action-target=103
menu name=main.2 button=* action=goto action-target=main
menu name=main.2 default action=goto action-target=main.2

menu name=dinner playfile=facdfc7ca2029552
menu name=dinner default action=redirect action-target=0-4

menu name=off-the-clock playfile=b1b2d11f59d8d208
menu name=off-the-clock default action=redirect action-target=blacklist

schedule name=dinner data=mo,tu,we,th,fr:1300-1400
schedule name=off-the-clock data=mo,tu,we,th,fr:0000-0900;1800-2400,sa,su
```

1. start
    * якщо дзвонить номер 111 або 222, то виконується перевод дзвінка на сценарій blacklist(положить трубку);
    * інакше якщо виконується умова schedule з назвою off-the-clock, то виконується перехід у меню off-the-clock
    * інакше якщо виконується умова schedule з назвою dinner, то виконується перехід у меню dinner;
    * інакше якщо дзвонить номер 112 або 223, то виконується перехід у меню main.1;
    * інакше виконується перехід у меню main.
1. main menu
    * Відтворюємо файл 43d8a740ec032766, час очікування на введення - 5,
    кількість повторів файлу, що відтворюється, якщо абонент нічого не натиснув  - 2, 
    Максимальна кількість символів, на введення яких очікувати - 2.
    * якщо натиснули 1, то виконується перехід у меню main.1;
    * інакше якщо натиснули 2, то виконується перехід у меню main.2;
    * інакше якщо натиснули 3, то виконується перевод дзвінка на сценарій 0-1;
    * інакше якщо натиснули 4, то виконується перевод дзвінка на внутрішній номер АТС 101;
    * інакше якщо натиснули 10, то виконується перевод дзвінка на внутрішній номер АТС 110;
    * иначе виконується перевод дзвінка на внутрішній номер АТС 100.
1. main.1 menu
    * Відтворюємо файл a279dd3a1da19e57;
    * якщо натиснули 1, то виконується перевод дзвінка на сценарій 0-2;
    * інакше якщо натиснули 2, то виконується перевод дзвінка на внутрішній номер АТС 102;
    * інакше якщо натиснули *, то виконується перехід у меню main;
    * інакше повторюємо menu.1.
1. main.2 menu
    * Відтворюємо файл a6842305f1996e34;
    * якщо натиснули 1, то виконується перевод дзвінка на сценарій 0-3;
    * інакше якщо натиснули 2, то виконується перевод дзвінка на внутрішній номер АТС 103;
    * інакше якщо натиснули *, то виконується перехід у меню main;
    * інакше повторюємо menu.2.
1. dinner menu
    * Відтворюємо файл facdfc7ca2029552;
    * виконується перевод дзвінка на сценарій 0-4.
1. off-the-clock menu
    * Відтворюємо файл b1b2d11f59d8d208;
    * виконується перевод дзвінка на сценарій blacklist(покласти трубку).
1. dinner schedule
    * Умова: з понеділка по п’ятницю з 13:00:00 до 13:59:59;
1. off-the-clock schedule
    * Умова: з понеділка по п’ятницю з 00:00:00 до 08:59:59,18:00:00 до 23:59:59, субота, неділя.

